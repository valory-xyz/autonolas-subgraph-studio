name: Deploy Subgraph

run-name: Deploy ${{ inputs.name }} ${{ inputs.version }}

on:
  workflow_dispatch:
    inputs:
      folder:
        description: "Subgraph folder (e.g., tokenomics)"
        required: true
        type: string
      name:
        description: "Subgraph name (e.g., olas-staking-mode)"
        required: true
        type: string
      version:
        description: "Version (e.g., v0.1.2)"
        required: true
        type: string
      manifest:
        description: "Manifest file (e.g., subgraph.yaml)"
        required: true
        type: string
        default: "subgraph.yaml"

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - name: Display deployment plan
        run: |
          echo "## üìã Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "- Subgraph folder: \`${{ inputs.folder }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Subgraph name: \`${{ inputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version: \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Manifest: \`${{ inputs.manifest }}\`" >> $GITHUB_STEP_SUMMARY

  validate-inputs:
    needs: plan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deployment branch
        run: |
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "‚ùå Error: Deployments are only allowed from the 'main' branch"
            echo "Current branch: $CURRENT_BRANCH"
            exit 1
          fi
          echo "‚úÖ Branch validation passed: deploying from main branch"

      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Error: Version must follow format vX.Y.Z (e.g., v0.1.2)"
            exit 1
          fi
          echo "‚úÖ Version format is valid: ${{ inputs.version }}"

      - name: Validate subgraph folder exists
        run: |
          SUBGRAPH_PATH="subgraphs/${{ inputs.folder }}"

          if [ ! -d "$SUBGRAPH_PATH" ]; then
            echo "‚ùå Error: Subgraph folder '$SUBGRAPH_PATH' does not exist!"
            echo ""
            echo "Available subgraphs:"
            ls -1 subgraphs/
            exit 1
          fi
          echo "‚úÖ Subgraph folder found: $SUBGRAPH_PATH"

      - name: Validate manifest file exists
        run: |
          MANIFEST_PATH="subgraphs/${{ inputs.folder }}/${{ inputs.manifest }}"

          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "‚ùå Error: Manifest file '$MANIFEST_PATH' does not exist!"
            echo ""
            echo "Available files in subgraphs/${{ inputs.folder }}:"
            ls -1 subgraphs/${{ inputs.folder }}/ | grep subgraph
            exit 1
          fi
          echo "‚úÖ Manifest file found: $MANIFEST_PATH"

  deploy:
    needs: validate-inputs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "yarn"

      - name: Install subgraph packages
        run: yarn install

      - name: Authenticate
        run: yarn graph auth ${{ secrets.SUBGRAPH_STUDIO_KEY }}

      - name: Generate code
        working-directory: subgraphs/${{ inputs.folder }}
        run: yarn graph codegen ${{ inputs.manifest }}

      - name: Build subgraph
        working-directory: subgraphs/${{ inputs.folder }}
        run: yarn graph build ${{ inputs.manifest }}

      - name: Deploy subgraph
        working-directory: subgraphs/${{ inputs.folder }}
        run: |
          yarn graph deploy \
            ${{ inputs.name }} \
            ${{ inputs.manifest }} \
            -l ${{ inputs.version }}

      - name: Deployment summary
        if: success()
        run: |
          echo "‚úÖ Subgraph deployed successfully"
          echo "- Subgraph folder: ${{ inputs.folder }}"
          echo "- Subgraph name: ${{ inputs.name }}"
          echo "- Version: ${{ inputs.version }}"
          echo "- Manifest: ${{ inputs.manifest }}"
